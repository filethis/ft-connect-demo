<!--
Copyright 2017 FileThis, Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->


<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/ft-confirmation-dialog/ft-confirmation-dialog.html">
<link rel="import" href="../bower_components/ft-connect-expand-out/ft-connect-expand-out.html">
<link rel="import" href="../bower_components/ft-connect-tabbed/ft-connect-tabbed.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="manager-panel.html">


<!--
`ft-connect-demo`
An element that defines the top-level of the FileThis partner application.

This is a fully-functional sample application that uses all of the components provided for building embedded partern applications.
-->

<dom-module id="ft-connect-demo">

    <template>

        <style include="iron-flex iron-flex-alignment iron-flex-factors"></style>

        <style>
            :host {
                display:block;
            }
        </style>

        <style>
            :host {
                width:100%;
                height:100%;
            }
        </style>

        <!-- Two-way bind the application route to the browser's address bar -->
        <app-location
                use-hash-as-path
                route="{{route}}">
        </app-location>

        <!-- Top -->
        <div class="layout horizontal"
            style="width:100%; height:100%; background-color:#FAFAFA">

            <!-- Manager panel -->
            <manager-panel
                    id="managerPanel"
                    flavor="{{flavor}}"
                    enabled="{{enabled}}"
                    can-enable="{{canEnable}}"
                    server="{{server}}"
                    user-account-id="{{userAccountId}}"
                    token="{{token}}"
                    component-name="{{componentName}}"
                    style="border-right:1px solid black;">
            </manager-panel>

            <!-- FileThis Connect panel and dead page -->
            <iron-pages id="liveOrDeadPages"
                        style="width:100%; height:100%;"
                        attr-for-selected="name"
                        selected="{{_enabledOrDisabledPageName}}">

                <!-- FileThis Connect panel -->
                <div
                        class="vertical layout center"
                        name="enabled"
                        style="width:100%; height:100%; ">

                    <iron-pages
                            style="padding-left:20px; padding-top:100px; padding-right:20px; padding-bottom:20px; "
                            attr-for-selected="name"
                            selected=[[flavor]]>

                        <!-- ft-connect-expand-out -->
                        <ft-connect-expand-out
                                name="ft-connect-expand-out"
                                enabled="[[enabled]]"
                                server="[[server]]"
                                api-path="[[apiPath]]"
                                user-account-id="[[userAccountId]]"
                                token="[[token]]"
                                interaction-version="[[interactionVersion]]"
                                route="{{route}}"
                                on-ft-connect-error="_handleFileThisConnectErrorEvent">
                        </ft-connect-expand-out>

                        <!-- ft-connect-tabbed -->
                        <div name="ft-connect-tabbed">
                            ft-connect-tabbed
                        </div>
                        <!--<div name="ft-connect-tabbed">-->
                            <!--<ft-connect-tabbed-->
                                    <!--name="ft-connect-tabbed"-->
                                    <!--style="width:100%; height:100%;"-->
                                    <!--enabled="[[enabled]]"-->
                                    <!--server="[[server]]"-->
                                    <!--api-path="[[apiPath]]"-->
                                    <!--user-account-id="[[userAccountId]]"-->
                                    <!--token="[[token]]"-->
                                    <!--interaction-version="[[interactionVersion]]"-->
                                    <!--route="{{route}}"-->
                                    <!--on-ft-connect-error="_handleFileThisConnectErrorEvent">-->
                            <!--</ft-connect-tabbed>-->
                        <!--</div>-->

                        <!-- ft-connect-mobile -->
                        <div name="ft-connect-mobile">
                            ft-connect-mobile
                        </div>

                    </iron-pages>
                </div>

                <!-- Disabled page -->
                <div
                        name="disabled"
                        class="vertical layout center"
                        style="width:100%; height:100%">
                    <div class="flex-1"></div>
                    <div>Disabled</div>
                    <div class="flex-2"></div>
                </div>

            </iron-pages>
        </div>

        <!-- Confirmation dialog -->
        <ft-confirmation-dialog id="confirmationDialog"></ft-confirmation-dialog>

    </template>

    <script>
        Polymer({

            is: 'ft-connect-demo',

            behaviors: [FileThis.ErrorBehavior, FileThis.HttpBehavior],

            listeners:
            {
                'tap': '_onTap'
            },

            properties:
            {
                flavor:
                {
                    type: String,
                    notify: true
                },

                /** Whether the FileThis Connect instance is enabled or not */
                enabled:
                {
                    type: Boolean,
                    notify: true,
                    value: false,
                    observer: "_onEnabledChanged"
                },

                /** Whether the FileThis Connect instance can be enabled or not */
                canEnable:
                {
                    type: Boolean,
                    notify: true,
                    value: false
                },

                /** The "base" URL for requests. For example: "https://filethis.com". Note that you should not use a trailing slash. */
                server:
                {
                    type: String,
                    value: "https://staging.filethis.com"
                },

                /** The path under the baseUrl used for API requests. For example: "/api/v1". Note that you should use a leading slash, and no trailing slash. */
                apiPath:
                {
                    type: String,
                    value: "/api/v1"
                },

                /** The user's FileThis account id. */
                userAccountId: {
                    type: String,
                    value: ""
                },

                /** The end-user FileThis token. Used to authenticate and authorize requests to the FileThis API endpoints. */
                token:
                {
                    type: String,
                    value: ""
                },

                /** Version of user interaction schema to use. */
                interactionVersion:
                {
                    type: Object,  // JSON
                    value: "1.0.0"
                },

                componentName:
                {
                    type: String,
                    notify: true,
                    value: null
                },

                // TODO: Remove once polling is done
                pollForChangeNotifications:
                {
                    type: Boolean,
                    value: true
                },

                _enabledOrDisabledPageName:
                {
                    type: String,
                    value: "disabled"
                },

                _suppressWriteToLocalStorage: {
                    type: Boolean,
                    value: true
                }
            },

            ready: function()
            {
                // TODO: Make auto-enable at startup a preference?
                this.async(function()
                {
                    if (this.canEnable)
                        this.enabled = true;
                }, 500)
            },

            _onTap: function(event)
            {
                var componentName = event.ftComponentName;
                this._inspect(componentName);
            },

            _inspect: function(componentName)
            {
                if (!!componentName)
                    this.componentName = componentName;
                else
                    this.componentName = null;
            },

            _onEnabledChanged: function(to, from)
            {
                if (this.enabled)
                    this._enabledOrDisabledPageName = "enabled";
                else
                    this._enabledOrDisabledPageName = "disabled";
            },

            _handleFileThisConnectErrorEvent: function(event)
            {
                this.enabled = false;

                var error = event.detail;

                // Handle certain server error responses
                if (error instanceof FtHttpUnsuccessfulError)
                {
                    var status = error.status;
                    var response = error.response;

                    // If the token expired, or is invalid
                    if (status === 400 &&
                        !!response &&
                        !!response.message &&
                        response.message === "User access token expired")
                    {
                        this.$.confirmationDialog.alert("User access token is expired or invalid.");
                        return;
                    }
                }

                this.handleCaughtError(error);
            }

        })

    </script>
</dom-module>
