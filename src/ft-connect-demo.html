<!--
Copyright 2017 FileThis, Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
--><link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/ft-confirmation-dialog/ft-confirmation-dialog.html">
<link rel="import" href="../bower_components/ft-connect-expand-out/ft-connect-expand-out.html">
<link rel="import" href="../bower_components/ft-connect-tabbed/ft-connect-tabbed.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="manager-panel.html">


<!--
`ft-connect-demo`
An element that defines the top-level of the FileThis partner application.

This is a fully-functional sample application that uses all of the components provided for building embedded partern applications.
-->

<dom-module id="ft-connect-demo">

    <template>

        <style include="iron-flex iron-flex-alignment iron-positioning iron-flex-factors"></style>

        <style>
            :host {
                display:block;

                --paper-button-raised-keyboard-focus: {
                    font-weight: normal;
                };
                --paper-button-flat-keyboard-focus: {
                    font-weight: normal;
                };
            }
        </style>

        <style>
            :host {
                width:100%;
                height:100%;
            }
        </style>

        <!-- Two-way bind the application route to the browser's address bar -->
        <app-location use-hash-as-path="" route="{{route}}">
        </app-location>

        <!-- Top -->
        <div class="layout horizontal" style="width:100%; height:100%; background-color:#FAFAFA">

            <!-- Manager panel -->
            <manager-panel id="managerPanel" live="{{live}}" can-go-live="{{canGoLive}}" server="{{server}}" user-account-id="{{userAccountId}}" token="{{token}}" component-name="{{componentName}}" style="border-right:1px solid #DDD;">
            </manager-panel>

            <!-- FileThis Connect panel -->
            <div class="layout vertical center" style="width:100%; height:100%; ">

                <!-- Header -->
                <div class="layout horizontal center" style="width:100%; height:55px; border-bottom:1px solid #DDD; ">

                    <!-- Title -->
                    <div style="font-family:Arial; font-size:16pt; padding-left:20px; ">
                        FileThisConnect Component
                    </div>

                    <!-- Variants -->
                    <paper-dropdown-menu label="Variant" style="width:200px; padding-left:20px; ">
                        <paper-listbox class="dropdown-content" slot="dropdown-content" selected="{{_selectedVariantIndex}}">
                            <template is="dom-repeat" items="[[variants]]" as="variant">
                                <paper-item>[[variant]]</paper-item>
                            </template>
                        </paper-listbox>
                    </paper-dropdown-menu>

                    <!-- API documentation button -->
                    <!--<ft-labeled-icon-button-->
                            <!--style="padding-left:20px; "-->
                            <!--icon="info-outline"-->
                            <!--label="API"-->
                            <!--on-tap="_onDocumentationButtonTapped">-->
                    <!--</ft-labeled-icon-button>-->

                    <!-- GitHub repository button -->
                    <!--<ft-labeled-icon-button-->
                            <!--style="padding-left:8px; "-->
                            <!--icon-src="./src/github.svg"-->
                            <!--label="Repo"-->
                            <!--on-tap="_onSourcesButtonTapped">-->
                    <!--</ft-labeled-icon-button>-->

                    <!-- Spacer -->
                    <div class="flex"></div>

                    <!-- Live button -->
                    <ft-labeled-icon-button id="liveButton" toggles="true" style="padding-left:30px; padding-right:16px; " disabled="[[!canGoLive]]" icon="power-settings-new" label="[[_calculateEnabledButtonLabel(live)]]" active="{{!live}}">
                    </ft-labeled-icon-button>

                </div>

                <!-- Live or dead pages -->
                <!-- Have to put iron-pages inside a div, or it will take too much vertical space... Bug? -->
                <div class="layout vertical" style="width:100%; height:100%; ">

                    <iron-pages id="liveOrDeadPages" style="width:100%; height:100%; " attr-for-selected="name" selected="{{_liveOrDeadPageName}}">

                        <div class="layout vertical center" name="live" style="width:100%; height:100%; ">

                            <div style="height:100px; "></div>

                            <!-- ft-connect-expand-out -->
                            <template is="dom-if" if="[[_variantExpandOut]]" restamp="true">
                                <ft-connect-expand-out live="[[live]]" server="[[server]]" api-path="[[apiPath]]" user-account-id="[[userAccountId]]" token="[[token]]" interaction-version="[[interactionVersion]]" route="{{route}}" debug="true" on-ft-connect-error="_handleFileThisConnectErrorEvent">
                                </ft-connect-expand-out>
                            </template>

                            <!-- ft-connect-tabbed -->
                            <template is="dom-if" if="[[_variantTabbed]]" restamp="true">
                                <ft-connect-tabbed style="width:780px; height:450px; " live="[[live]]" server="[[server]]" api-path="[[apiPath]]" user-account-id="[[userAccountId]]" token="[[token]]" interaction-version="[[interactionVersion]]" route="{{route}}" debug="true" on-ft-connect-error="_handleFileThisConnectErrorEvent">
                                </ft-connect-tabbed>
                            </template>

                        </div>

                        <!-- Disabled page -->
                        <div name="dead" class="layout vertical center" style="width:100%; height:100%; ">

                            <!-- Spacer -->
                            <div style="height:100px; "></div>

                            <!-- Dotted outline to show where the component will go -->
                            <div class="layout vertical center" style="width:600px; height:400px; border-style:dashed; border-color:#C0C0C0; border-width:2px; padding:10px; ">

                                <!-- Title -->
                                <div style="color:#A9A9A9; font-family:Arial;">[[selectedVariant]]</div>

                                <!-- Instructions -->
                                <div class="layout horizontal center" style="height:100% ">

                                    <div class="layout vertical start">

                                        <div>Click the power button in the upper right corner</div>
                                        <div>to inject the user access token into this component</div>
                                        <div>and tell it connect to the FileThis services.</div>

                                    </div>

                                </div>
                            </div>
                        </div>

                    </iron-pages>
                </div>
            </div>
        </div>

        <!-- Confirmation dialog -->
        <ft-confirmation-dialog id="confirmationDialog"></ft-confirmation-dialog>

    </template>

    <script>
        Polymer({

            is: 'ft-connect-demo',

            behaviors: [FileThis.ErrorBehavior, FileThis.HttpBehavior],

            listeners:
            {
                'tap': '_onTap'
            },

            properties:
            {
                selectedVariant:
                {
                    type: String,
                    notify: true,
                    value: "ft-connect-tabbed",
                    observer: "_onSelectedVariantChanged"
                },

                variants:
                {
                    type: Array,
                    notify: true,
                    value: [
                        'ft-connect-expand-out',
                        'ft-connect-tabbed'
                    ]
                },

                _selectedVariantIndex:
                {
                    type: Number,
                    notify: true,
                    value: "1",
                    observer: "_onSelectedVariantIndexChanged"
                },

                /** Whether the FileThis Connect instance is live or not */
                live:
                {
                    type: Object,
                    notify: true,
                    value: false,
                    observer: "_onLiveChanged"
                },

                /** Whether the FileThis Connect instance can be live or not */
                canGoLive:
                {
                    type: Object,
                    notify: true,
                    value: false
                },

                /** The "base" URL for requests. For example: "https://filethis.com". Note that you should not use a trailing slash. */
                server:
                {
                    type: String,
                    value: "https://staging.filethis.com"
                },

                /** The path under the baseUrl used for API requests. For example: "/api/v1". Note that you should use a leading slash, and no trailing slash. */
                apiPath:
                {
                    type: String,
                    value: "/api/v1"
                },

                /** The user's FileThis account id. */
                userAccountId: {
                    type: String,
                    value: ""
                },

                /** The end-user FileThis token. Used to authenticate and authorize requests to the FileThis API endpoints. */
                token:
                {
                    type: String,
                    value: ""
                },

                /** Version of user interaction schema to use. */
                interactionVersion:
                {
                    type: Object,  // JSON
                    value: "1.0.0"
                },

                componentName:
                {
                    type: String,
                    notify: true,
                    value: null
                },

                // TODO: Remove once polling is done
                pollForChangeNotifications:
                {
                    type: Boolean,
                    value: true
                },

                _liveOrDeadPageName:
                {
                    type: String,
                    value: "dead"
                },

                _suppressWriteToLocalStorage: {
                    type: Boolean,
                    value: true
                },

                _variantExpandOut: {
                    type: Boolean,
                    value: false
                },

                _variantTabbed: {
                    type: Boolean,
                    value: false
                },

                _variantWizard: {
                    type: Boolean,
                    value: false
                },

                _variantExpandIn: {
                    type: Boolean,
                    value: false
                }
            },

            ready: function()
            {
                // TODO: Make auto-enable at startup a preference?
                this.async(function()
                {
                    if (this.canGoLive)
                        this.live = true;
                }, 500)
            },

            _onTap: function(event)
            {
                var componentName = event.ftComponentName;
                this._inspect(componentName);
            },

            _onDocumentationButtonTapped: function(event)
            {
                this._openConnectElementDocumentationPage();
            },

            _onSourcesButtonTapped: function(event)
            {
                this._openConnectElementSourcesPage();
            },

            _openConnectElementDocumentationPage: function(event)
            {
                var url = "https://filethis.github.io/" + this.selectedVariant;
                this._openUrl(url);
            },

            _openConnectElementSourcesPage: function(event)
            {
                var url = "https://github.com/filethis/" + this.selectedVariant;
                this._openUrl(url);
            },

            _openUrl: function(url)
            {
                var win = window.open(url, '_blank');
                if (win)
                    win.focus();
                else
                    this.$.confirmationDialog.alert("Please allow popups for this site");
            },

            _inspect: function(componentName)
            {
                if (!!componentName)
                    this.componentName = componentName;
                else
                    this.componentName = null;
            },

            _onLiveChanged: function(to, from)
            {
                if (this.live)
                    this._liveOrDeadPageName = "live";
                else
                    this._liveOrDeadPageName = "dead";

                // Change the icon color of the power button
                var iconColor;
                if (this.live)
                    iconColor = "limegreen";
                else
                    iconColor = "firebrick";
                this.$.liveButton.updateStyles({
                    '--ft-labeled-icon-button-icon-fill-color': iconColor
                });
            },

            _calculateEnabledButtonLabel: function(live)
            {
                if (live)
                    return "On";
                else
                    return "Off";
            },

            _handleFileThisConnectErrorEvent: function(event)
            {
                this.live = false;

                var error = event.detail;

                // Handle certain server error responses
                if (error instanceof FtHttpUnsuccessfulError)
                {
                    var status = error.status;
                    var response = error.response;

                    // If the token expired, or is invalid
                    if (status === 400 &&
                        !!response &&
                        !!response.message &&
                        response.message === "User access token expired")
                    {
                        this.$.confirmationDialog.alert("User access token is expired or invalid.");
                        return;
                    }
                }

                this.handleCaughtError(error);
            },

            _onSelectedVariantChanged: function(to, from)
            {
                // Update the popup selection
                this._selectedVariantIndex = this._mapVariantToIndex(this.selectedVariant);

                this._variantExpandOut = false;
                this._variantTabbed = false;
                this._variantWizard = false;
                this._variantExpandIn = false;

                switch (this.selectedVariant)
                {
                    case "ft-connect-expand-out":
                        this._variantExpandOut = true;
                        break;
                    case "ft-connect-tabbed":
                        this._variantTabbed = true;
                        break;
                    case "ft-connect-wizard":
                        this._variantWizard = true;
                        break;
                    case "ft-connect-expand-in":
                        this._variantExpandIn = true;
                        break;
                    default:
                        throw new Error("Unknown FileThis Connect variant: " + variant);
                }
            },

            _mapVariantToIndex: function(variant)
            {
                switch (variant)
                {
                    case "ft-connect-expand-out":
                        return 0;
                    case "ft-connect-tabbed":
                        return 1;
                    case "ft-connect-wizard":
                        return 2;
                    case "ft-connect-expand-in":
                        return 3;
                    default:
                        throw new Error("Unknown FileThis Connect variant: " + variant);
                }
            },

            _onSelectedVariantIndexChanged: function()
            {
                switch (this._selectedVariantIndex)
                {
                    case 0:
                        this.selectedVariant = "ft-connect-expand-out";
                        break;
                    case 1:
                        this.selectedVariant = "ft-connect-tabbed";
                        break;
                    case 2:
                        this.selectedVariant = "ft-connect-wizard";
                        break;
                    case 3:
                        this.selectedVariant = "ft-connect-expand-in";
                        break;
                    default:
                        throw new Error("Invalid variant index: " + this._selectedVariantIndex.toString());
                }
            }

        })

    </script>
</dom-module>
